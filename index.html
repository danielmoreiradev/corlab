import React, { useState, useEffect, useRef, useMemo } from 'react';
import { 
  Copy, Trash2, Plus, Image as ImageIcon, Download, Palette, 
  RefreshCw, CheckCircle2, Eye, ArrowRightLeft, Sparkles, 
  Code, MousePointer2, Zap, Layout, Type, Search, Settings,
  ShieldCheck, Smartphone, Monitor, ChevronRight, DownloadCloud,
  Layers, Move, Info, Save, Archive, X
} from 'lucide-react';

// --- Utilitários de Cor de Alta Performance ---
const hexToRgb = (hex) => {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result ? {
    r: parseInt(result[1], 16),
    g: parseInt(result[2], 16),
    b: parseInt(result[3], 16)
  } : { r: 0, g: 0, b: 0 };
};

const rgbToHex = (r, g, b) => {
  return "#" + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('').toUpperCase();
};

const getLuminance = (r, g, b) => {
  const a = [r, g, b].map(v => {
    v /= 255;
    return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
  });
  return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722;
};

const getContrastRatio = (hex1, hex2) => {
  if (!hex1 || !hex2) return "1.00";
  const rgb1 = hexToRgb(hex1);
  const rgb2 = hexToRgb(hex2);
  const l1 = getLuminance(rgb1.r, rgb1.g, rgb1.b) + 0.05;
  const l2 = getLuminance(rgb2.r, rgb2.g, rgb2.b) + 0.05;
  return (Math.max(l1, l2) / Math.min(l1, l2)).toFixed(2);
};

const rgbToHsl = (r, g, b) => {
  r /= 255; g /= 255; b /= 255;
  const max = Math.max(r, g, b), min = Math.min(r, g, b);
  let h, s, l = (max + min) / 2;
  if (max === min) h = s = 0;
  else {
    const d = max - min;
    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
    if (max === r) h = (g - b) / d + (g < b ? 6 : 0);
    else if (max === g) h = (b - r) / d + 2;
    else h = (r - g) / d + 4;
    h /= 6;
  }
  return { h: Math.round(h * 360), s: Math.round(s * 100), l: Math.round(l * 100) };
};

const hslToRgb = (h, s, l) => {
  s /= 100; l /= 100; h /= 360;
  let r, g, b;
  const hue2rgb = (p, q, t) => {
    if (t < 0) t += 1; if (t > 1) t -= 1;
    if (t < 1/6) return p + (q - p) * 6 * t;
    if (t < 1/2) return q;
    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
    return p;
  };
  const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
  const p = 2 * l - q;
  r = hue2rgb(p, q, h + 1/3); g = hue2rgb(p, q, h); b = hue2rgb(p, q, h - 1/3);
  return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) };
};

const commonIcons = [
  "fas fa-arrow-right", "fas fa-rocket", "fas fa-check", "fas fa-star", 
  "fas fa-shopping-cart", "fas fa-envelope", "fas fa-phone", "fas fa-user",
  "fas fa-download", "fas fa-play", "fas fa-plus", "fas fa-search",
  "fas fa-paper-plane", "fas fa-heart", "fas fa-bell", "fas fa-globe"
];

const colorPsychology = {
  vermelho: { desc: "Paixão, Urgência, Perigo, Energia. Ótimo para CTAs de impacto.", baseH: 0, s: 80, l: 50 },
  azul: { desc: "Confiança, Segurança, Inteligência, Calma. Padrão corporativo e tecnologia.", baseH: 220, s: 70, l: 50 },
  verde: { desc: "Crescimento, Saúde, Natureza, Sorte. Ideal para sustentabilidade e finanças.", baseH: 140, s: 60, l: 45 },
  amarelo: { desc: "Otimismo, Felicidade, Atenção. Use para atrair o olhar com moderação.", baseH: 50, s: 90, l: 50 },
  roxo: { desc: "Luxo, Mistério, Criatividade, Espiritualidade. Perfeito para marcas premium.", baseH: 270, s: 60, l: 50 },
  laranja: { desc: "Amizade, Entusiasmo, Criatividade. Menos agressivo que o vermelho.", baseH: 30, s: 85, l: 55 },
  rosa: { desc: "Feminilidade, Romance, Doçura, Diversão.", baseH: 330, s: 70, l: 60 },
  preto: { desc: "Sofisticação, Poder, Elegância, Luto. Essencial para contraste e minimalismo.", baseH: 0, s: 0, l: 10 },
  branco: { desc: "Pureza, Limpeza, Modernidade, Espaço. O herói do espaço negativo.", baseH: 0, s: 0, l: 95 }
};

const App = () => {
  useEffect(() => {
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css';
    document.head.appendChild(link);
  }, []);

  // --- States ---
  const [colors, setColors] = useState([
    { id: 1, hex: '#6366F1', opacity: 100 },
    { id: 2, hex: '#F43F5E', opacity: 100 },
    { id: 3, hex: '#10B981', opacity: 100 }
  ]);
  const [activeTab, setActiveTab] = useState('palette');
  const [notif, setNotif] = useState(null);
  const fileInputRef = useRef(null);
  
  // Persistence States
  const [savedPalettes, setSavedPalettes] = useState(() => {
    const saved = localStorage.getItem('cm_pro_palettes');
    return saved ? JSON.parse(saved) : [];
  });
  const [isNamingModalOpen, setIsNamingModalOpen] = useState(false);
  const [exportType, setExportType] = useState(null); // 'txt', 'jpg' or 'save'
  const [paletteName, setPaletteName] = useState('');

  // Acessibilidade State
  const [accBg, setAccBg] = useState('#6366F1');
  const [accFg, setAccFg] = useState('#FFFFFF');

  // Gradient State
  const [gradStops, setGradStops] = useState([
    { id: 1, hex: '#6366F1', opacity: 100 },
    { id: 2, hex: '#A855F7', opacity: 100 }
  ]);
  const [gradType, setGradType] = useState('linear');
  const [gradAngle, setGradAngle] = useState(135);
  const [gradClass, setGradClass] = useState('bg-matrix-gradient');
  const [gradTextPreview, setGradTextPreview] = useState('#FFFFFF');

  // Button State
  const [btn, setBtn] = useState({
    text: 'Quero meu desconto',
    pt: 16, pb: 16, pl: 32, pr: 32,
    radius: 12, border: 0, borderColor: '#e2e8f0',
    bgType: 'gradient', bgSolid: '#6366F1',
    textColor: '#FFFFFF', hoverBg: '#4F46E5',
    animation: 'float', icon: 'fas fa-rocket',
    iconPos: 'right', customClass: 'btn-main-cta'
  });

  const notify = (msg) => {
    setNotif(msg);
    setTimeout(() => setNotif(null), 3000);
  };

  const copy = (txt) => {
    const el = document.createElement('textarea');
    el.value = txt; document.body.appendChild(el); el.select();
    document.execCommand('copy'); document.body.removeChild(el);
    notify("Copiado com sucesso!");
  };

  // Sync with LocalStorage
  useEffect(() => {
    localStorage.setItem('cm_pro_palettes', JSON.stringify(savedPalettes));
  }, [savedPalettes]);

  // --- Memos ---
  const currentGradient = useMemo(() => {
    const s = gradStops.map(st => {
      const rgb = hexToRgb(st.hex);
      return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${st.opacity/100})`;
    }).join(', ');
    return gradType === 'linear' ? `linear-gradient(${gradAngle}deg, ${s})` : `radial-gradient(circle, ${s})`;
  }, [gradStops, gradType, gradAngle]);

  const contrast = useMemo(() => getContrastRatio(accBg, accFg), [accBg, accFg]);

  // --- Handlers ---
  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = new Image();
      img.onload = () => {
        const c = document.createElement('canvas');
        const ctx = c.getContext('2d');
        c.width = img.width; c.height = img.height;
        ctx.drawImage(img, 0, 0);
        const pts = [[0.1, 0.1], [0.5, 0.5], [0.9, 0.9], [0.2, 0.8], [0.8, 0.2], [0.5, 0.1]];
        const res = pts.map(p => ({
          id: Math.random(),
          hex: rgbToHex(...ctx.getImageData(img.width * p[0], img.height * p[1], 1, 1).data),
          opacity: 100
        }));
        setColors(res);
        setAccBg(res[0].hex);
        setAccFg('#FFFFFF');
        notify("Cores extraídas!");
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  };

  const executeExport = () => {
    if (!paletteName.trim()) return;

    if (exportType === 'txt') {
      const content = colors.map(c => `${c.hex} (${c.opacity}%)`).join('\n');
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `${paletteName.replace(/\s+/g, '-')}.txt`; a.click();
      notify("Arquivo TXT baixado!");
    } 
    else if (exportType === 'jpg') {
      const canvas = document.createElement('canvas');
      canvas.width = 1200; canvas.height = 600;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      colors.forEach((c, i) => {
        ctx.fillStyle = c.hex;
        ctx.fillRect(i * (1200 / colors.length), 0, 1200 / colors.length, 450);
        ctx.fillStyle = '#0F172A';
        ctx.font = 'bold 24px Inter, sans-serif';
        ctx.fillText(c.hex, i * (1200 / colors.length) + 20, 520);
      });
      ctx.fillStyle = '#94a3b8';
      ctx.font = '16px Inter, sans-serif';
      ctx.fillText(`Paleta: ${paletteName}`, 20, 570);
      const a = document.createElement('a');
      a.download = `${paletteName.replace(/\s+/g, '-')}.jpg`;
      a.href = canvas.toDataURL('image/jpeg');
      a.click();
      notify("Imagem JPG baixada!");
    }
    else if (exportType === 'save') {
      const newPalette = {
        id: Date.now(),
        name: paletteName,
        colors: [...colors],
        date: new Date().toLocaleDateString('pt-BR')
      };
      setSavedPalettes([newPalette, ...savedPalettes]);
      notify("Paleta salva no sistema!");
    }

    setIsNamingModalOpen(false);
    setPaletteName('');
  };

  const generateHarmony = (type) => {
    if (colors.length === 0) return;
    const base = colors[0];
    const { h, s, l } = rgbToHsl(...Object.values(hexToRgb(base.hex)));
    let res = [];
    if (type === 'comp') res = [base.hex, rgbToHex(...Object.values(hslToRgb((h+180)%360, s, l)))];
    if (type === 'tri') res = [base.hex, rgbToHex(...Object.values(hslToRgb((h+120)%360, s, l))), rgbToHex(...Object.values(hslToRgb((h+240)%360, s, l)))];
    const newPalette = res.map(h => ({id: Math.random(), hex: h, opacity: 100}));
    setColors(newPalette);
    setAccBg(newPalette[0].hex);
    setAccFg(newPalette[1].hex);
    notify(`Harmonia aplicada!`);
  };

  const getBtnCss = () => {
    const bg = btn.bgType === 'solid' ? btn.bgSolid : currentGradient;
    return `.${btn.customClass} {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: ${btn.pt}px ${btn.pr}px ${btn.pb}px ${btn.pl}px;
  background: ${bg};
  color: ${btn.textColor};
  border: ${btn.border}px solid ${btn.borderColor};
  border-radius: ${btn.radius}px;
  font-weight: 800;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
  ${btn.animation !== 'none' ? `animation: ${btn.animation} 3s infinite;` : ''}
}
.${btn.customClass}:hover {
  filter: brightness(1.1);
  transform: translateY(-2px);
  box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2);
}`;
  };

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans selection:bg-indigo-500/20 pb-12">
      
      {/* MODAL DE NOMENCLATURA (NOVO) */}
      {isNamingModalOpen && (
        <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm animate-in fade-in duration-200">
           <div className="w-full max-w-md bg-white rounded-[2rem] shadow-2xl p-8 border border-slate-100">
              <div className="flex justify-between items-start mb-6">
                 <div>
                    <h3 className="text-xl font-black tracking-tight text-slate-900 uppercase">Identificar Projeto</h3>
                    <p className="text-xs font-bold text-slate-400 uppercase tracking-tighter">Obrigatório para organização</p>
                 </div>
                 <button onClick={() => setIsNamingModalOpen(false)} className="p-2 hover:bg-slate-50 rounded-full transition-all text-slate-400"><X className="w-5 h-5"/></button>
              </div>
              <div className="space-y-6">
                 <div className="space-y-2">
                    <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest px-1">Nome da Marca ou Cliente</label>
                    <input 
                      autoFocus
                      type="text" 
                      value={paletteName} 
                      onChange={(e) => setPaletteName(e.target.value)}
                      onKeyDown={(e) => e.key === 'Enter' && executeExport()}
                      className="w-full px-5 py-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:border-indigo-600 focus:ring-4 focus:ring-indigo-50 font-bold transition-all" 
                      placeholder="Ex: Cliente João WordPress"
                    />
                 </div>
                 <div className="flex gap-3">
                    <button onClick={() => setIsNamingModalOpen(false)} className="flex-1 py-4 text-xs font-black uppercase text-slate-400 hover:bg-slate-50 rounded-2xl transition-all tracking-widest">Cancelar</button>
                    <button 
                      disabled={!paletteName.trim()}
                      onClick={executeExport}
                      className={`flex-1 py-4 text-xs font-black uppercase rounded-2xl shadow-xl transition-all tracking-widest flex items-center justify-center gap-2
                      ${paletteName.trim() ? 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-indigo-200' : 'bg-slate-100 text-slate-300 cursor-not-allowed'}`}
                    >
                      {exportType === 'save' ? <Save className="w-4 h-4"/> : <Download className="w-4 h-4"/>}
                      {exportType === 'save' ? 'Salvar Agora' : 'Confirmar'}
                    </button>
                 </div>
              </div>
           </div>
        </div>
      )}

      {/* HEADER LIGHT SaaS */}
      <header className="sticky top-0 z-50 w-full border-b border-slate-200 bg-white/80 backdrop-blur-xl px-4 py-3 md:px-8">
        <div className="max-w-7xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="bg-indigo-600 p-2.5 rounded-2xl shadow-xl shadow-indigo-500/20">
              <Palette className="w-5 h-5 text-white" />
            </div>
            <div>
               <h1 className="text-sm font-black tracking-widest text-slate-900 uppercase">Cor <span className="text-indigo-600">LAB</span></h1>
            </div>
          </div>
          
          <div className="flex items-center gap-1.5 md:gap-3">
            <label className="cursor-pointer bg-white border border-slate-200 hover:bg-slate-50 p-2.5 rounded-xl transition-all shadow-sm" title="Extrair de Imagem">
              <ImageIcon className="w-4 h-4 text-indigo-600" />
              <input type="file" className="hidden" accept="image/*" onChange={handleImageUpload} />
            </label>
            <button onClick={() => { setExportType('txt'); setIsNamingModalOpen(true); }} className="bg-white border border-slate-200 hover:bg-slate-50 p-2.5 rounded-xl transition-all shadow-sm" title="Download .TXT">
              <DownloadCloud className="w-4 h-4 text-indigo-600" />
            </button>
            <button onClick={() => { setExportType('jpg'); setIsNamingModalOpen(true); }} className="bg-white border border-slate-200 hover:bg-slate-50 px-4 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all shadow-sm hidden sm:block">
              Exportar .JPG
            </button>
            <button onClick={() => { setExportType('save'); setIsNamingModalOpen(true); }} className="bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all shadow-lg shadow-indigo-500/30 flex items-center gap-2">
              <Save className="w-4 h-4"/> Salvar Paleta
            </button>
          </div>
        </div>
      </header>

      {notif && (
        <div className="fixed bottom-8 left-1/2 -translate-x-1/2 z-[150] animate-in fade-in slide-in-from-bottom-4">
          <div className="bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 border border-indigo-500/20">
            <CheckCircle2 className="w-4 h-4 text-indigo-400" />
            <span className="text-[10px] font-black uppercase tracking-widest">{notif}</span>
          </div>
        </div>
      )}

      <main className="max-w-7xl mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8 mb-10">
        
        {/* NAVEGAÇÃO */}
        <nav className="lg:col-span-3 flex lg:flex-col gap-1 overflow-x-auto pb-4 lg:pb-0 scrollbar-hide">
          {[
            { id: 'palette', label: '1. Paleta & Hub', icon: Palette },
            { id: 'gradient', label: '2. Gradient Lab', icon: Zap },
            { id: 'buttons', label: '3. Button Studio', icon: MousePointer2 },
            { id: 'insights', label: '4. Insights Pro', icon: Sparkles },
            { id: 'saved', label: '5. Minhas Paletas', icon: Archive }
          ].map(tab => (
            <button 
              key={tab.id} onClick={() => setActiveTab(tab.id)}
              className={`flex items-center gap-3 px-5 py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all whitespace-nowrap flex-1 lg:flex-none border
              ${activeTab === tab.id ? 'bg-white border-indigo-100 text-indigo-600 shadow-xl shadow-indigo-500/10' : 'bg-transparent border-transparent text-slate-400 hover:text-slate-600'}`}
            >
              <tab.icon className="w-4 h-4" /> {tab.label}
            </button>
          ))}
        </nav>

        {/* WORKSPACE */}
        <div className="lg:col-span-9 space-y-8">
          
          <div className="bg-white border border-slate-200 p-6 md:p-10 rounded-[2.5rem] shadow-sm relative overflow-hidden min-h-[600px]">
            
            {/* 1. PALETA HUB */}
            {activeTab === 'palette' && (
              <div className="space-y-12 animate-in fade-in duration-500">
                <section>
                  <div className="flex justify-between items-center mb-8">
                    <h2 className="text-xl font-black text-slate-900 tracking-tighter uppercase">Painel Cromático</h2>
                    <div className="flex gap-2">
                       <button onClick={() => generateHarmony('comp')} className="text-[9px] font-black px-3 py-2 bg-slate-50 rounded-lg hover:bg-slate-100 text-indigo-600 transition-all border border-slate-200 uppercase">Complementar</button>
                       <button onClick={() => generateHarmony('tri')} className="text-[9px] font-black px-3 py-2 bg-slate-50 rounded-lg hover:bg-slate-100 text-indigo-600 transition-all border border-slate-200 uppercase">Tríade</button>
                       <button onClick={() => setColors([...colors, {id:Date.now(), hex:'#94a3b8', opacity:100}])} className="p-2.5 bg-indigo-600 rounded-xl hover:bg-indigo-500 text-white shadow-lg"><Plus className="w-4 h-4"/></button>
                    </div>
                  </div>
                  
                  <div className="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-5 gap-4">
                    {colors.map(c => (
                      <div key={c.id} className="bg-slate-50 p-4 rounded-3xl border border-slate-200 group hover:border-indigo-400 transition-all">
                        <div className="h-28 w-full rounded-2xl mb-4 shadow-sm cursor-pointer relative overflow-hidden border border-black/5" style={{ backgroundColor: c.hex, opacity: c.opacity/100 }} onClick={() => copy(c.hex)}>
                           <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 bg-black/10 transition-opacity"><Copy className="w-5 h-5 text-white"/></div>
                        </div>
                        <input type="color" value={c.hex} onChange={(e) => setColors(colors.map(col => col.id === c.id ? {...col, hex:e.target.value} : col))} className="w-full h-10 bg-transparent border-none cursor-pointer mb-1"/>
                        
                        <div className="space-y-1 mb-3 px-1">
                           <label className="text-[8px] font-black text-slate-400 uppercase flex justify-between">Opacidade <span>{c.opacity}%</span></label>
                           <input type="range" min="0" max="100" value={c.opacity} onChange={(e) => setColors(colors.map(col => col.id === c.id ? {...col, opacity:parseInt(e.target.value)} : col))} className="w-full h-1 accent-indigo-600 appearance-none bg-slate-200 rounded-full"/>
                        </div>

                        <div className="flex justify-between items-center px-1">
                          <span className="text-[11px] font-mono font-black text-slate-600 uppercase tracking-tighter">{c.hex}</span>
                          <button onClick={() => setColors(colors.filter(col => col.id !== c.id))} className="text-slate-300 hover:text-red-500"><Trash2 className="w-4 h-4"/></button>
                        </div>
                        <div className="flex gap-1.5 mt-4">
                           <button onClick={() => setAccBg(c.hex)} className="flex-1 py-1.5 bg-white border border-slate-200 text-[8px] font-black uppercase rounded-md hover:bg-slate-100 transition-all">Plano de Fundo</button>
                           <button onClick={() => setAccFg(c.hex)} className="flex-1 py-1.5 bg-white border border-slate-200 text-[8px] font-black uppercase rounded-md hover:bg-slate-100 transition-all">Cor do Texto</button>
                        </div>
                      </div>
                    ))}
                  </div>
                </section>

                {/* ACESSIBILIDADE WCAG */}
                <section className="bg-slate-50 p-8 rounded-[2rem] border border-slate-200 shadow-inner">
                   <div className="grid grid-cols-1 md:grid-cols-2 gap-10 items-start">
                      <div className="space-y-6">
                        <div className="flex items-center gap-3">
                           <ShieldCheck className={`w-5 h-5 ${contrast >= 4.5 ? 'text-emerald-500' : 'text-amber-500'}`} />
                           <h3 className="text-xs font-black text-slate-900 uppercase tracking-[0.2em]">WCAG Contrast Lab</h3>
                        </div>
                        <div className="flex items-end gap-4">
                           <div className="text-5xl font-black text-slate-900 tracking-tighter leading-none">{contrast}</div>
                           <div className="space-y-1">
                             <div className={`text-[10px] font-black px-2 py-0.5 rounded flex items-center gap-1.5 ${contrast >= 4.5 ? 'bg-emerald-500 text-white' : 'bg-slate-200 text-slate-500'}`}>
                               {contrast >= 4.5 && <CheckCircle2 className="w-3 h-3" />} Normal (AA)
                             </div>
                             <div className={`text-[10px] font-black px-2 py-0.5 rounded flex items-center gap-1.5 ${contrast >= 7 ? 'bg-emerald-500 text-white' : 'bg-slate-200 text-slate-500'}`}>
                               {contrast >= 7 && <CheckCircle2 className="w-3 h-3" />} Rigoroso (AAA)
                             </div>
                           </div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                           <div className="space-y-2">
                             <span className="text-[9px] font-black text-slate-400 uppercase">Plano de Fundo</span>
                             <div className="flex items-center gap-3 bg-white p-2 rounded-xl border border-slate-200">
                               <input type="color" value={accBg} onChange={(e) => setAccBg(e.target.value)} className="w-8 h-8 rounded-lg bg-transparent border-none cursor-pointer"/>
                               <span className="font-mono text-xs font-bold">{accBg}</span>
                             </div>
                           </div>
                           <div className="space-y-2">
                             <span className="text-[9px] font-black text-slate-400 uppercase">Cor do Texto</span>
                             <div className="flex items-center gap-3 bg-white p-2 rounded-xl border border-slate-200">
                               <input type="color" value={accFg} onChange={(e) => setAccFg(e.target.value)} className="w-8 h-8 rounded-lg bg-transparent border-none cursor-pointer"/>
                               <span className="font-mono text-xs font-bold">{accFg}</span>
                             </div>
                           </div>
                        </div>
                        
                        <button onClick={() => { const b = accBg; setAccBg(accFg); setAccFg(b); }} className="w-full py-3 bg-white border border-slate-200 text-slate-600 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-slate-50 transition-all shadow-sm">
                          <ArrowRightLeft className="w-4 h-4 inline mr-2" /> Inverter Camadas
                        </button>

                        <div className="pt-4 border-t border-slate-200">
                           <span className="text-[8px] font-black text-slate-400 uppercase tracking-widest block mb-3">Check Rápido: Paleta vs Fundo Atual</span>
                           <div className="flex flex-wrap gap-2">
                              {colors.map(c => {
                                const localRatio = getContrastRatio(accBg, c.hex);
                                return (
                                  <div key={c.id} onClick={() => setAccFg(c.hex)} className={`cursor-pointer px-2 py-1 rounded-md border text-[9px] font-bold transition-all flex items-center gap-1.5 ${localRatio >= 4.5 ? 'bg-emerald-50 border-emerald-100 text-emerald-700' : 'bg-rose-50 border-rose-100 text-rose-700'}`}>
                                    <div className="w-2 h-2 rounded-full" style={{ backgroundColor: c.hex }}></div>
                                    {localRatio}
                                  </div>
                                );
                              })}
                           </div>
                        </div>
                      </div>
                      <div className="h-48 rounded-[2rem] flex flex-col items-center justify-center p-8 text-center shadow-lg transition-all duration-500 border border-black/5" style={{ backgroundColor: accBg }}>
                        <span className="text-2xl font-black mb-2" style={{ color: accFg }}>Legibilidade Real</span>
                        <p className="text-xs font-bold opacity-80" style={{ color: accFg }}>Se você consegue ler isso confortavelmente, o usuário também conseguirá.</p>
                      </div>
                   </div>
                </section>
              </div>
            )}

            {/* 2. GRADIENT LAB */}
            {activeTab === 'gradient' && (
              <div className="space-y-10 animate-in fade-in duration-500">
                <div className="w-full h-64 rounded-[2.5rem] border-8 border-white shadow-xl transition-all duration-700 flex items-center justify-center p-8" style={{ background: currentGradient }}>
                   <div className="text-center">
                      <h3 className="text-4xl font-black tracking-tighter mb-2" style={{ color: gradTextPreview }}>Título de Exemplo</h3>
                      <p className="text-sm font-bold opacity-80" style={{ color: gradTextPreview }}>Visualização de texto sobre o gradiente.</p>
                   </div>
                </div>
                {/* ... (Gradient Lab Controls - Mantidos da v3.8) ... */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-10">
                  <div className="space-y-6">
                    <div className="flex justify-between items-center"><h4 className="text-[10px] font-black text-slate-400 uppercase flex items-center gap-2"><Layers className="w-4 h-4"/> Color Stops</h4><button onClick={() => setGradStops([...gradStops, {id:Date.now(), hex:'#F43F5E', opacity:100}])} className="bg-slate-100 p-2 rounded-xl text-indigo-600 hover:bg-slate-200 transition-all"><Plus className="w-4 h-4"/></button></div>
                    <div className="space-y-4 max-h-[350px] overflow-y-auto pr-3 custom-scrollbar">
                      {gradStops.map(s => (
                        <div key={s.id} className="bg-slate-50 p-4 rounded-2xl border border-slate-200 flex items-center gap-4">
                           <input type="color" value={s.hex} onChange={(e) => setGradStops(gradStops.map(stop => stop.id === s.id ? {...stop, hex:e.target.value} : stop))} className="w-10 h-10 rounded-xl bg-transparent border-none cursor-pointer"/>
                           <div className="flex-1 space-y-1">
                              <div className="flex justify-between text-[8px] font-black text-slate-400 uppercase">Opacidade <span>{s.opacity}%</span></div>
                              <input type="range" min="0" max="100" value={s.opacity} onChange={(e) => setGradStops(gradStops.map(stop => stop.id === s.id ? {...stop, opacity:parseInt(e.target.value)} : stop))} className="w-full accent-indigo-500 appearance-none bg-slate-200 h-1 rounded-full"/>
                           </div>
                           <button onClick={() => setGradStops(gradStops.filter(stop => stop.id !== s.id))} className="text-slate-300 hover:text-red-500"><Trash2 className="w-4 h-4"/></button>
                        </div>
                      ))}
                    </div>
                  </div>
                  <div className="space-y-6">
                    <div className="bg-slate-900 p-8 rounded-[2.5rem] border border-slate-800 relative shadow-inner">
                      <div className="flex justify-between items-center mb-6"><span className="text-[10px] font-black text-slate-400 uppercase flex items-center gap-2"><Code className="w-4 h-4 text-indigo-400"/> CSS Engine</span><button onClick={() => copy(`background: ${currentGradient};`)} className="text-indigo-500 hover:text-white"><Copy className="w-4 h-4"/></button></div>
                      <pre className="text-[11px] text-indigo-300 font-mono leading-relaxed whitespace-pre-wrap break-all h-24 overflow-y-auto custom-scrollbar">{`background: ${currentGradient};`}</pre>
                    </div>
                    <div className="p-4 bg-slate-50 rounded-2xl border border-slate-200 flex items-center justify-between"><span className="text-[10px] font-black text-slate-400 uppercase">Cor do Texto Preview</span><input type="color" value={gradTextPreview} onChange={(e) => setGradTextPreview(e.target.value)} className="w-8 h-8 rounded-lg cursor-pointer bg-transparent border-none"/></div>
                    <div className="grid grid-cols-2 gap-3">
                      <button onClick={() => setGradType('linear')} className={`py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all border ${gradType === 'linear' ? 'bg-indigo-600 border-indigo-600 text-white' : 'bg-white border-slate-200 text-slate-400'}`}>Linear</button>
                      <button onClick={() => setGradType('radial')} className={`py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all border ${gradType === 'radial' ? 'bg-indigo-600 border-indigo-600 text-white' : 'bg-white border-slate-200 text-slate-400'}`}>Radial</button>
                    </div>
                    {gradType === 'linear' && <input type="range" min="0" max="360" value={gradAngle} onChange={(e) => setGradAngle(e.target.value)} className="w-full accent-indigo-500"/>}
                  </div>
                </div>
              </div>
            )}

            {/* 3. BUTTON STUDIO */}
            {activeTab === 'buttons' && (
              <div className="space-y-10 animate-in fade-in duration-500">
                <div className="w-full h-56 bg-white rounded-[3rem] border border-slate-200 flex items-center justify-center pattern-dots-light relative overflow-hidden shadow-inner">
                   <a href="#" className={`${btn.customClass} ${btn.animation !== 'none' ? `anim-${btn.animation}` : ''}`}
                    style={{
                      padding: `${btn.pt}px ${btn.pr}px ${btn.pb}px ${btn.pl}px`, borderRadius: `${btn.radius}px`,
                      background: btn.bgType === 'solid' ? btn.bgSolid : currentGradient, color: btn.textColor,
                      border: `${btn.border}px solid ${btn.borderColor}`, fontWeight: '800', fontSize: '15px', textDecoration: 'none',
                      display: 'inline-flex', alignItems: 'center', gap: '12px', transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                      boxShadow: '0 15px 30px -10px rgba(0,0,0,0.1)', letterSpacing: '0.02em'
                    }}>
                     {btn.iconPos === 'left' && <i className={btn.icon}></i>}
                     {btn.text}
                     {btn.iconPos === 'right' && <i className={btn.icon}></i>}
                   </a>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  <div className="bg-slate-50 p-6 rounded-[2rem] border border-slate-200 space-y-5">
                    <h5 className="text-[10px] font-black text-slate-500 uppercase flex items-center gap-2"><Type className="w-3 h-3"/> Conteúdo</h5>
                    <input type="text" value={btn.text} onChange={(e) => setBtn({...btn, text:e.target.value})} className="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-xs font-bold outline-none focus:border-indigo-400"/>
                    <div className="grid grid-cols-4 gap-2 max-h-32 overflow-y-auto p-1 custom-scrollbar">
                      {commonIcons.map(icon => (<button key={icon} onClick={() => setBtn({...btn, icon: icon})} className={`p-2.5 rounded-lg border transition-all ${btn.icon === icon ? 'bg-indigo-600 text-white' : 'bg-white border-slate-200 text-slate-400'}`}><i className={icon}></i></button>))}
                    </div>
                  </div>
                  <div className="bg-slate-50 p-6 rounded-[2rem] border border-slate-200 space-y-5">
                    <h5 className="text-[10px] font-black text-slate-500 uppercase flex items-center gap-2"><Move className="w-3 h-3"/> Layout</h5>
                    <div className="grid grid-cols-2 gap-2">
                       {['pt', 'pb', 'pl', 'pr'].map(p => (<div key={p} className="space-y-1"><label className="text-[8px] font-black text-slate-500 uppercase">{p} {btn[p]}px</label><input type="range" min="0" max="80" value={btn[p]} onChange={(e) => setBtn({...btn, [p]:parseInt(e.target.value)})} className="w-full accent-indigo-500"/></div>))}
                    </div>
                    <div className="space-y-1"><label className="text-[8px] font-black text-slate-500 uppercase">Radius {btn.radius}px</label><input type="range" min="0" max="50" value={btn.radius} onChange={(e) => setBtn({...btn, radius:parseInt(e.target.value)})} className="w-full accent-indigo-500"/></div>
                  </div>
                  <div className="bg-slate-50 p-6 rounded-[2rem] border border-slate-200 space-y-5">
                    <h5 className="text-[10px] font-black text-slate-500 uppercase flex items-center gap-2"><Zap className="w-3 h-3"/> Estilo</h5>
                    <select value={btn.animation} onChange={(e) => setBtn({...btn, animation:e.target.value})} className="w-full h-11 px-4 rounded-xl bg-white border border-slate-200 text-[10px] font-black uppercase outline-none">
                      <option value="none">Sem Animação</option><option value="float">Flutuar</option><option value="glow">Glow</option><option value="shake">Shake</option>
                    </select>
                    <div className="grid grid-cols-2 gap-2">
                      <input type="color" value={btn.bgSolid} onChange={(e) => setBtn({...btn, bgSolid:e.target.value, bgType:'solid'})} className="w-full h-10 rounded-xl bg-transparent border-none cursor-pointer"/><input type="color" value={btn.textColor} onChange={(e) => setBtn({...btn, textColor:e.target.value})} className="w-full h-10 rounded-xl bg-transparent border-none cursor-pointer"/>
                    </div>
                    <button onClick={() => setBtn({...btn, bgType:'gradient'})} className={`w-full py-2.5 rounded-xl text-[9px] font-black uppercase border ${btn.bgType === 'gradient' ? 'bg-indigo-600 text-white' : 'bg-white'}`}>Usar Gradiente Lab</button>
                  </div>
                </div>
                <div className="bg-white p-8 rounded-[2.5rem] border border-slate-200 space-y-6 shadow-xl">
                   <div className="flex justify-between items-center"><span className="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2"><Code className="w-4 h-4 text-indigo-600"/> Bundle Pro</span><button onClick={() => copy(getBtnCss())} className="text-indigo-600 transition-all"><Copy className="w-5 h-5"/></button></div>
                   <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <pre className="p-5 bg-slate-900 rounded-2xl text-[10px] font-mono text-indigo-300 overflow-x-auto h-48 custom-scrollbar">{getBtnCss()}</pre>
                      <div className="p-5 bg-slate-50 rounded-2xl text-[10px] font-mono text-slate-700 border border-slate-200 h-48 flex flex-col justify-center"><code>{`<a href="#" class="${btn.customClass}">${btn.text}</a>`}</code></div>
                   </div>
                </div>
              </div>
            )}

            {/* 4. PSICOLOGIA INSIGHTS */}
            {activeTab === 'insights' && (
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-6 animate-in fade-in duration-500">
                {Object.entries(colorPsychology).map(([key, val]) => (
                  <div key={key} className="bg-slate-50 p-8 rounded-[2.5rem] border border-slate-200 flex items-start gap-6 hover:border-indigo-400 transition-all cursor-pointer group shadow-sm" onClick={() => { 
                    const rgb = hslToRgb(val.baseH, val.s, val.l); 
                    const pickedHex = rgbToHex(rgb.r, rgb.g, rgb.b);
                    setAccBg(key === 'branco' ? '#FFFFFF' : key === 'preto' ? '#0F172A' : pickedHex); 
                    setAccFg(key === 'branco' ? '#0F172A' : '#FFFFFF');
                    notify("Conceito aplicado e medido!"); 
                  }}>
                    <div className="w-14 h-14 rounded-[1.25rem] shadow-md border-2 border-white shrink-0 transition-transform group-hover:scale-110" style={{ backgroundColor: 
                      key === 'branco' ? '#FFF' : key === 'preto' ? '#0F172A' : `hsl(${val.baseH}, ${val.s}%, ${val.l}%)` 
                    }}></div>
                    <div className="space-y-2">
                       <h4 className="font-black uppercase text-[12px] text-slate-900 tracking-[0.1em] group-hover:text-indigo-600 transition-colors">{key}</h4>
                       <p className="text-[11px] text-slate-500 leading-relaxed font-bold italic">"{val.desc}"</p>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* 5. MINHAS PALETAS (NOVA ABA) */}
            {activeTab === 'saved' && (
              <div className="space-y-8 animate-in fade-in duration-500">
                 <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-black text-slate-900 tracking-tighter uppercase">Minhas Paletas Salvas</h2>
                    <span className="text-[10px] font-black px-3 py-1 bg-slate-100 rounded-full text-slate-400 uppercase">{savedPalettes.length} Projetos</span>
                 </div>

                 {savedPalettes.length === 0 ? (
                   <div className="h-64 flex flex-col items-center justify-center border-2 border-dashed border-slate-100 rounded-[2.5rem] text-slate-300">
                      <Archive className="w-12 h-12 mb-4 opacity-20" />
                      <p className="font-bold text-sm uppercase tracking-widest">Nenhuma paleta salva ainda</p>
                   </div>
                 ) : (
                   <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      {savedPalettes.map(p => (
                        <div key={p.id} className="bg-slate-50 border border-slate-200 p-6 rounded-[2rem] hover:border-indigo-400 transition-all group shadow-sm">
                           <div className="flex justify-between items-start mb-6">
                              <div>
                                 <h4 className="font-black text-slate-900 uppercase tracking-tight text-lg leading-none mb-1">{p.name}</h4>
                                 <p className="text-[9px] font-black text-slate-400 uppercase tracking-widest">{p.date}</p>
                              </div>
                              <button onClick={() => setSavedPalettes(savedPalettes.filter(item => item.id !== p.id))} className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-all">
                                 <Trash2 className="w-4 h-4" />
                              </button>
                           </div>
                           
                           <div className="flex h-12 w-full rounded-xl overflow-hidden mb-6 shadow-inner border border-black/5">
                              {p.colors.map((c, i) => (
                                <div key={i} className="flex-1" style={{ backgroundColor: c.hex }} title={c.hex}></div>
                              ))}
                           </div>

                           <div className="flex gap-2">
                              <button 
                                onClick={() => { setColors(p.colors); setActiveTab('palette'); notify("Paleta carregada!"); }}
                                className="flex-1 py-3 bg-white border border-slate-200 text-[9px] font-black uppercase tracking-widest text-slate-600 rounded-xl hover:bg-indigo-600 hover:text-white hover:border-indigo-600 transition-all shadow-sm"
                              >
                                Carregar Projeto
                              </button>
                              <button 
                                onClick={() => { 
                                  const content = p.colors.map(c => `${c.hex}`).join('\n');
                                  const blob = new Blob([content], { type: 'text/plain' });
                                  const url = URL.createObjectURL(blob);
                                  const a = document.createElement('a'); a.href = url; a.download = `${p.name}.txt`; a.click();
                                }}
                                className="p-3 bg-white border border-slate-200 text-slate-400 rounded-xl hover:bg-slate-50 transition-all shadow-sm"
                              >
                                <DownloadCloud className="w-4 h-4"/>
                              </button>
                           </div>
                        </div>
                      ))}
                   </div>
                 )}
              </div>
            )}
          </div>
        </div>
      </main>

      <footer className="fixed bottom-0 z-50 w-full bg-white/80 backdrop-blur-md border-t border-slate-200 px-8 py-3 hidden md:flex justify-between items-center text-slate-400">
        <div className="flex items-center gap-6 text-[9px] font-black uppercase tracking-[0.3em]">
           <span className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-emerald-500"></div> Database Engine Online</span>
           <span className="text-slate-200">|</span>
           <span>SaaS Pro // Creative Workflow</span>
        </div>
        <div className="flex gap-4"><Monitor className="w-3.5 h-3.5"/><Smartphone className="w-3.5 h-3.5"/></div>
      </footer>

      <style>{`
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .pattern-dots-light { background-image: radial-gradient(#e2e8f0 1.5px, transparent 1.5px); background-size: 20px 20px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: #6366f1; border-radius: 50%; border: 2px solid white; cursor: pointer; box-shadow: 0 0 10px rgba(99,102,241,0.2); }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
        .anim-float { animation: float 3s ease-in-out infinite; }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 10px rgba(0,0,0,0.1); } 50% { box-shadow: 0 0 30px rgba(0,0,0,0.2); } }
        .anim-glow { animation: glow 2s ease-in-out infinite; }
        @keyframes shake { 0%, 100% { transform: rotate(0); } 25% { transform: rotate(-3deg); } 75% { transform: rotate(3deg); } }
        .anim-shake { animation: shake 0.5s infinite; }
      `}</style>
    </div>
  );
};

export default App;